var cacheManager=Titanium.App.Properties.getObject("cachedXHRDocuments",{});XHR=function(){},XHR.prototype.get=function(e,t,i,o){Titanium.API.info(e);var t=t||function(){},i=i||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.ttl=o.ttl||!1,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var l=readCache(e);if(o.ttl&&0!=l){var a={};a.status="cache",a.data=l,t(a)}else{var r=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(r.setRequestHeader("Content-Type",o.contentType),r.open("GET",e,o.async),o.shouldAuthenticate){var n="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);r.setRequestHeader("Authorization",n)}r.onload=function(){a.status=200==r.status?"ok":r.status,a.data=-1!=o.contentType.indexOf("application/json")?r.responseText:-1!=o.contentType.indexOf("text/xml")?r.responseXML:r.responseData,t(a),writeCache(a.data,e,o.ttl)},r.onerror=function(e){a.status="error",a.data=e,a.code=r.status,i(a)},r.send()}},XHR.prototype.post=function(e,t,i,o,l){Titanium.API.info(e+" "+JSON.stringify(t));var i=i||function(){},o=o||function(){},l=l||{};l.async=l.hasOwnProperty("async")?l.async:!0,l.shouldAuthenticate=l.shouldAuthenticate||!1,l.contentType=l.contentType||"application/json";var a=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),r={};if(a.open("POST",e,l.async),a.setRequestHeader("Content-Type",l.contentType),l.shouldAuthenticate){var n="Basic "+Titanium.Utils.base64encode(l.username+":"+l.password);a.setRequestHeader("Authorization",n)}a.onload=function(){r.status=200==a.status?"ok":a.status,r.data=a.responseText,i(r)},a.onerror=function(e){r.status="error",r.data=e.error,r.code=a.status,o(r)},a.send(t)},XHR.prototype.put=function(e,t,i,o,l){var i=i||function(){},o=o||function(){},l=l||{};l.async=l.hasOwnProperty("async")?l.async:!0,l.shouldAuthenticate=l.shouldAuthenticate||!1,l.contentType=l.contentType||"application/json";var a=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),r={};if(a.open("PUT",e,l.async),a.setRequestHeader("Content-Type",l.contentType),l.shouldAuthenticate){var n="Basic "+Titanium.Utils.base64encode(l.username+":"+l.password);a.setRequestHeader("Authorization",n)}a.onload=function(){r.status=200==a.status?"ok":a.status,r.data=a.responseText,i(r)},a.onerror=function(e){r.status="error",r.data=e.error,r.code=a.status,o(r)},a.send(t)},XHR.prototype.destroy=function(e,t,i,o){Titanium.API.info(e);var t=t||function(){},i=i||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var l=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(l.open("DELETE",e,o.async),l.setRequestHeader("Content-Type",o.contentType),o.shouldAuthenticate){var r="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);l.setRequestHeader("Authorization",r)}l.onload=function(){a.status=200==l.status?"ok":l.status,a.data=l.responseText,t(a)},l.onerror=function(e){a.status="error",a.data=e.error,a.code=l.status,i(a)},l.send()},XHR.prototype.clear=function(e){if(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t];if(i){var o=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],o.deleteFile(),updateCacheManager()}}},XHR.prototype.clean=function(){var e=(new Date).getTime(),t=0;for(var i in cacheManager){var o=cacheManager[i];if(o.timestamp<=e){var l=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,i);delete cacheManager[i],l.deleteFile(),updateCacheManager(),t+=1}}return t},XHR.prototype.purge=function(){var e=0;for(var t in cacheManager){cacheManager[t];var i=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],i.deleteFile(),updateCacheManager(),e+=1}return e},readCache=function(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t],o=!1;if(i){var l=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);i.timestamp>=(new Date).getTime()?o=l.read():(delete cacheManager[t],l.deleteFile(),updateCacheManager())}return o},updateCacheManager=function(){Titanium.App.Properties.setObject("cachedXHRDocuments",cacheManager)},writeCache=function(e,t,i){var o=Titanium.Utils.md5HexDigest(t),l=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,o);l.write(e),cacheManager[o]={timestamp:(new Date).getTime()+60*i*1e3},updateCacheManager()},module.exports=XHR;